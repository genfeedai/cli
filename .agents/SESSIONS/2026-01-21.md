# Session Log: 2026-01-21

## Session 1: Biome 2.3.11 Upgrade + Husky Pre-commit Hooks

**Time:** Evening
**Duration:** ~10 minutes

### System Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    Pre-commit Workflow                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  git commit → .husky/pre-commit → bunx lint-staged          │
│                                        │                    │
│                                        ▼                    │
│                           biome check --write               │
│                           (on staged files only)            │
│                                        │                    │
│                                        ▼                    │
│                           ✅ Pass → Commit proceeds         │
│                           ❌ Fail → Commit blocked          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Affected Components

- **Tooling:** Biome linter/formatter, Husky git hooks, lint-staged
- **Configuration:** biome.json, package.json
- **Git Hooks:** .husky/pre-commit

### What Was Done

- [x] Upgraded `@biomejs/biome` from `1.9.4` to `^2.3.11`
- [x] Migrated biome.json to 2.3.11 schema
  - Changed `organizeImports.enabled` → `assist.actions.source.organizeImports: "on"`
  - Changed `noConsoleLog` → `noConsole` (renamed in 2.x)
  - Added `files.includes` for explicit file targeting
- [x] Added `husky@^9.1.7` and `lint-staged@^15.5.2` as devDependencies
- [x] Added `prepare: "husky"` script
- [x] Configured lint-staged for `.ts`, `.tsx`, `.js`, `.jsx`, `.json` files
- [x] Created `.husky/pre-commit` hook running `bunx lint-staged`
- [x] Auto-fixed 4 files (import ordering, JSON array formatting)
- [x] Verified `bun run lint` passes

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Use `files.includes` instead of deprecated `files.ignore` | Biome 2.x removed `ignore` key, uses `includes` with explicit patterns |
| Use `bunx lint-staged` in pre-commit | Ensures lint-staged uses project's local version |
| Include `--no-errors-on-unmatched` flag | Prevents errors when no files match patterns |

### Files Changed

| File | Action | Description |
|------|--------|-------------|
| `biome.json` | Modified | Upgraded schema to 2.3.11, migrated deprecated config |
| `package.json` | Modified | Added husky, lint-staged, prepare script |
| `.husky/pre-commit` | Created | Pre-commit hook for lint-staged |
| `src/commands/generate/image.ts` | Auto-fixed | Import ordering |
| `src/commands/generate/video.ts` | Auto-fixed | Import ordering |
| `tests/utils/errors.test.ts` | Auto-fixed | Import ordering |

### Mistakes and Fixes

| Mistake | Fix |
|---------|-----|
| Initially used `files.ignore` (removed in Biome 2.x) | Changed to `files.includes` with explicit patterns |
| Used `noConsoleLog` (renamed in Biome 2.x) | Changed to `noConsole` |

### Patterns Established

1. **Pre-commit linting:** All commits now auto-lint staged files
2. **Biome 2.x config:** Use `assist.actions.source.organizeImports` for import sorting
3. **Explicit file includes:** Target specific directories instead of excluding

### Next Steps

- Test pre-commit hook with an actual commit
- Consider adding typecheck to pre-commit if desired

---

## Session 2: WebSocket Implementation + OSS Preparation

**Time:** Late Evening
**Duration:** ~30 minutes

### System Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│              Generation Flow (Before: Polling)                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  CLI → POST /videos → API returns {id}                              │
│        ↓                                                            │
│  LOOP: GET /videos/{id} every 2-5s until status=completed           │
│        (wasteful, slow, not real-time)                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│              Generation Flow (After: WebSocket)                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  CLI → POST /videos → API returns {id}                              │
│        ↓                                                            │
│  CLI opens WebSocket to api.genfeed.ai (outbound connection)        │
│        ↓                                                            │
│  Server authenticates via API key, joins CLI to user-{id} room      │
│        ↓                                                            │
│  External AI completes → webhook → Redis pub/sub                    │
│        ↓                                                            │
│  Server pushes 'background-task-update' event to CLI's room         │
│        ↓                                                            │
│  CLI receives event instantly, fetches result, disconnects          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Affected Components

- **CLI:** `src/utils/websocket.ts` (new), `src/commands/generate/*.ts`
- **Dependencies:** Added `socket.io-client`
- **Removed:** `src/utils/polling.ts`, `tests/utils/polling.test.ts`
- **Docs:** README.md, CONTRIBUTING.md

### What Was Done

- [x] Fixed ASCII banner in README (simpler chars that render on GitHub)
- [x] Split code blocks in README for single-command copy
- [x] Fixed polling tests (fake timer issues with large time values)
- [x] Added `socket.io-client` dependency
- [x] Created `src/utils/websocket.ts` with `waitForCompletion()` function
- [x] Updated `image.ts` and `video.ts` commands to use WebSocket
- [x] Created tests for WebSocket implementation (8 tests)
- [x] Removed polling utility entirely (was deprecated)
- [x] Added badges to README (npm, CI, license)
- [x] Added Requirements section to README
- [x] Created CONTRIBUTING.md with dev setup, scripts, PR process
- [x] Verified no hardcoded secrets or internal URLs
- [x] All checks pass (lint, typecheck, 58 tests)

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| WebSocket over polling | Real-time updates, no wasted API calls, industry standard |
| Remove polling entirely | No fallback needed - API has solid WebSocket support |
| OSS the CLI | Industry norm, builds trust, CLI has no proprietary logic |
| MIT license | Already in place, most permissive for developer tools |

### Files Changed

| File | Action | Description |
|------|--------|-------------|
| `package.json` | Modified | Added socket.io-client dependency |
| `src/utils/websocket.ts` | Created | WebSocket service with waitForCompletion() |
| `src/utils/polling.ts` | Deleted | Replaced by WebSocket |
| `src/commands/generate/image.ts` | Modified | Use waitForCompletion instead of poll |
| `src/commands/generate/video.ts` | Modified | Use waitForCompletion instead of poll |
| `tests/utils/websocket.test.ts` | Created | 8 tests for WebSocket implementation |
| `tests/utils/polling.test.ts` | Deleted | No longer needed |
| `README.md` | Modified | Fixed banner, badges, requirements, contributing link |
| `CONTRIBUTING.md` | Created | Dev setup, scripts, code style, PR process |

### Mistakes and Fixes

| Mistake | Fix |
|---------|-----|
| ASCII banner used Unicode blocks that didn't render on GitHub | Changed to simple ASCII art |
| Polling test with 300000ms timeout caused real 5s delay | Simplified test to use smaller values |

### Patterns Established

1. **WebSocket for real-time:** CLI connects outbound, server pushes events
2. **Room-based targeting:** `user-{clerkId}` rooms for multi-tenant isolation
3. **Event filtering:** Filter by taskId and taskType to ignore irrelevant events
4. **OSS CLI structure:** README with badges, CONTRIBUTING.md, MIT license

### Next Steps

- Set up `NPM_TOKEN` secret in GitHub repo for publishing
- Create first GitHub release to trigger npm publish
- Consider adding `CODECOV_TOKEN` for coverage reports

---
